{% extends "admin/admin_base.html" %}
{% block content %}
<div class="p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold text-gray-800 mb-8 border-b pb-2">Verifikasi Pendaftar ({{ pending_users | length }} Permintaan)</h1>

    {% if pending_users %}
    <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama & Prodi</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kontak</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bukti</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for user in pending_users %}
                <tr id="row-{{ user.id }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.nim }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {{ user.nama_lengkap }}<br>
                        <span class="text-xs text-blue-600 font-semibold">{{ user.prodi }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ user.email }}<br>
                        {{ user.hp }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <!-- SOLUSI FINAL: Tautan langsung ke URL yang disimpan di DB -->
                        <!-- user.bukti_url disimpan sebagai 'uploads/proofs/filename.ext', jadi kita panggil langsung -->
                        <a href="/{{ user.bukti_url }}" target="_blank" class="text-indigo-500 hover:text-indigo-700 hover:underline">
                            Lihat Bukti <i class="fas fa-external-link-alt ml-1"></i>
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <!-- Tombol Terima -->
                        <form method="POST" action="{{ url_for('admin.accept_user', pending_id=user.id) }}" style="display:inline;" onsubmit="return confirm('Yakin ingin menerima akun ini? Akun mahasiswa akan dibuat otomatis.');">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md text-xs transition duration-150 shadow-md">
                                Terima <i class="fas fa-check ml-1"></i>
                            </button>
                        </form>
                        
                        <!-- Tombol Tolak (Modal/Dropdown) -->
                        <button onclick="showRejectModal('{{ user.id }}', '{{ user.nama_lengkap }}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition duration-150 ml-2 shadow-md">
                            Tolak <i class="fas fa-times ml-1"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-green-50 p-6 rounded-lg border border-green-200 text-center">
        <p class="text-xl text-green-700 font-semibold">ðŸŽ‰ Semua pendaftar sudah diverifikasi. Tidak ada permintaan tertunda.</p>
    </div>
    {% endif %}
</div>

<!-- Modal Tolak Permintaan (Menggunakan Vanilla JS dan Tailwind) -->
<div id="rejectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full">
        <h2 class="text-2xl font-bold mb-4 text-red-700">Tolak Permintaan Akun</h2>
        <p class="mb-4">Tolak akun untuk <span id="rejectUserName" class="font-semibold"></span>.</p>
        
        <form id="rejectForm" method="POST" action="">
            <!-- Perhatian: form di-include dari admin/routes.py -->
            {% if reject_form %}
                {{ reject_form.hidden_tag() }}
                
                <div>
                    {{ reject_form.alasan.label(class_="block text-sm font-medium text-gray-700 mb-1") }}
                    {{ reject_form.alasan(class_="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500", rows=4, placeholder="Tuliskan alasan penolakan secara jelas...") }}
                    {% for error in reject_form.alasan.errors %}
                        <span class="text-red-500 text-xs">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideRejectModal()" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition duration-150">Batal</button>
                    {{ reject_form.submit(class_="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-md transition duration-150 cursor-pointer") }}
                </div>
            {% endif %}
        </form>
    </div>
</div>

<script>
    function showRejectModal(userId, userName) {
        document.getElementById('rejectUserName').textContent = userName;
        const form = document.getElementById('rejectForm');
        // Set action URL form berdasarkan ID user yang ditolak
        // Menggunakan teknik string replacement untuk Jinja2 di JS
        form.action = "{{ url_for('admin.reject_user', pending_id=0) }}".replace('/0', '/' + userId);
        document.getElementById('rejectModal').style.display = 'flex';
        // Reset form error state jika ada
        const textarea = document.getElementById('alasan');
        if (textarea) textarea.value = '';
    }

    function hideRejectModal() {
        document.getElementById('rejectModal').style.display = 'none';
    }
</script>
{% endblock content %}